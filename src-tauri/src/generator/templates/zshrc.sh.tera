########################################################################
# 13/13 â€” Master .zshrc
########################################################################
print_header "ğŸ  13/13 â€” Master .zshrc"
cat >> "$ZSHRC" << 'ZRC'

# â•â• GHOSTTY ULTIMATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export PATH="$HOME/.local/bin:$PATH"
eval "$(starship init zsh)"
eval "$(zoxide init zsh)"
eval "$(atuin init zsh {{ config.zshrc.atuin_flags }})"

# fzf init
if command -v fzf &>/dev/null; then
  source <(fzf --zsh 2>/dev/null) || true
elif [ -f ~/.fzf.zsh ]; then
  source ~/.fzf.zsh
fi

export FZF_DEFAULT_OPTS=" \
  --color=bg+:{{ palette.selection }},bg:{{ palette.bg }},spinner:{{ palette.purple }},hl:{{ palette.red }} \
  --color=fg:{{ palette.fg }},header:{{ palette.red }},info:{{ palette.purple }},pointer:{{ palette.blue }} \
  --color=marker:{{ palette.green }},fg+:{{ palette.fg }},prompt:{{ palette.blue }},hl+:{{ palette.br_red }} \
  --color=selected-bg:{{ palette.selection }} \
  --border={{ config.zshrc.fzf.border }} --prompt='{{ config.zshrc.fzf.prompt }}' --marker='{{ config.zshrc.fzf.marker }}' --pointer='{{ config.zshrc.fzf.pointer }}' \
  --separator='{{ config.zshrc.fzf.separator }}' --scrollbar='{{ config.zshrc.fzf.scrollbar }}' --layout={{ config.zshrc.fzf.layout }} --height={{ config.zshrc.fzf.height }}"

export FZF_DEFAULT_COMMAND='{{ config.zshrc.fzf.default_command }}'
export FZF_CTRL_T_OPTS="{{ config.zshrc.fzf.ctrl_t_opts }}"
export FZF_ALT_C_OPTS="{{ config.zshrc.fzf.alt_c_opts }}"

if type brew &>/dev/null; then
  FPATH="$(brew --prefix)/share/zsh-completions:${FPATH}"
  FPATH="$(brew --prefix)/share/zsh/site-functions:${FPATH}"
fi

autoload -Uz compinit && compinit -C

zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' group-name ''
zstyle ':completion:*:descriptions' format '[%d]'
zstyle ':completion:*' menu no

[ -f "$HOME/.local/share/fzf-tab/fzf-tab.plugin.zsh" ] && source "$HOME/.local/share/fzf-tab/fzf-tab.plugin.zsh" >/dev/null 2>&1
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always --icons $realpath'
zstyle ':fzf-tab:complete:z:*' fzf-preview 'eza -1 --color=always --icons $realpath'
zstyle ':fzf-tab:complete:(cat|bat|vim|nvim):*' fzf-preview '[[ -f $realpath ]] && bat -n --color=always --line-range :200 $realpath || eza -1 --color=always --icons $realpath'
zstyle ':fzf-tab:complete:git-(add|diff|restore):*' fzf-preview 'git diff $word | delta'
zstyle ':fzf-tab:complete:git-log:*' fzf-preview 'git log --color=always $word'
zstyle ':fzf-tab:complete:git-checkout:*' fzf-preview 'case "$group" in "modified file") git diff $word | delta ;; *) git log --color=always $word ;; esac'
zstyle ':fzf-tab:complete:(kill|ps):*' fzf-preview '[[ $group == "[process ID]" ]] && ps -p $word -o pid,user,%cpu,%mem,command'
zstyle ':fzf-tab:complete:(export|unset):*' fzf-preview 'echo ${(P)word}'
zstyle ':fzf-tab:*' continuous-trigger '/'
zstyle ':fzf-tab:*' switch-group '<' '>'
[ -n "$TMUX" ] && zstyle ':fzf-tab:*' fzf-command ftb-tmux-popup

[ -f "$HOME/.local/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ] && source "$HOME/.local/share/zsh-autosuggestions/zsh-autosuggestions.zsh" >/dev/null 2>&1
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg={{ palette.comment }}'
ZSH_AUTOSUGGEST_STRATEGY=({{ config.zshrc.autosuggestions.strategy }})

# zsh-vi-mode: block=NORMAL | beam=INSERT | underline=REPLACE
if [ -f "$HOME/.local/share/zsh-vi-mode/zsh-vi-mode.plugin.zsh" ]; then
  ZVM_VI_INSERT_ESCAPE_BINDKEY={{ config.zshrc.vi_mode.escape_bindkey }}
  ZVM_CURSOR_STYLE_ENABLED={{ config.zshrc.vi_mode.cursor_style_enabled | bool_to_str }}
  ZVM_LINE_INIT_MODE=$ZVM_MODE_INSERT
  source "$HOME/.local/share/zsh-vi-mode/zsh-vi-mode.plugin.zsh"
  zvm_after_init_commands=("source <(fzf --zsh 2>/dev/null) || true")
fi

[ -f "$HOME/.local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ] && source "$HOME/.local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" >/dev/null 2>&1

HISTSIZE={{ config.zshrc.history.size }}; SAVEHIST={{ config.zshrc.history.save }}; HISTFILE="$HOME/.zsh_history"
setopt APPEND_HISTORY SHARE_HISTORY HIST_IGNORE_SPACE HIST_IGNORE_ALL_DUPS HIST_SAVE_NO_DUPS HIST_FIND_NO_DUPS HIST_REDUCE_BLANKS INC_APPEND_HISTORY

bindkey '^[[A' history-search-backward; bindkey '^[[B' history-search-forward
bindkey '\ef' forward-word; bindkey '\eb' backward-word
bindkey '^A' beginning-of-line; bindkey '^E' end-of-line
bindkey '^K' kill-line; bindkey '^U' backward-kill-line
bindkey '^X^E' edit-command-line; autoload -z edit-command-line; zle -N edit-command-line

export EDITOR={{ config.zshrc.editor }}
export VISUAL={{ config.zshrc.visual }}
export BAT_THEME="{{ config.zshrc.bat_theme }}"
export MANPAGER="{{ config.zshrc.manpager }}"

# â”€â”€ Aliases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{% for alias in config.zshrc.aliases %}
alias {{ alias.name }}='{{ alias.value }}'
{% endfor %}

# rm â†’ trash only in interactive shells
[[ $- == *i* ]] && alias rm='trash'

# â”€â”€ Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{% for func in config.zshrc.functions %}
function {{ func.name }}() { {{ func.body }} }
{% endfor %}

if [[ $- == *i* ]] && [[ -z "$TMUX" ]]; then command fastfetch 2>/dev/null; fi
if [[ $- == *i* ]] && [[ -n "$TMUX" ]] && [[ "${TMUX_CHEAT:-1}" == "1" ]]; then
  if [[ -z "$TMUX_CHEAT_SHOWN" ]]; then export TMUX_CHEAT_SHOWN=1; command tmux-cheat 2>/dev/null; fi
fi
# â•â• END GHOSTTY ULTIMATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ZRC
print_step "Master .zshrc deployed"
